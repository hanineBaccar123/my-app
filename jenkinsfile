pipeline {
    agent any
    
    environment {
        DOCKERHUB_CREDENTIALS_ID = 'dockerhub-creds'
        IMAGE_NAME_SERVER = 'haninebaccar/mern-server'
        IMAGE_NAME_CLIENT = 'haninebaccar/mern-client'
        SERVER_CHANGED = 'false'
        CLIENT_CHANGED = 'false'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì• R√©cup√©ration du code source...'
                checkout scm
            }
        }
        
        stage('Detect Changes') {
            steps {
                script {
                    echo 'üîç D√©tection des changements dans le repository...'
                    
                    // V√©rifier si c'est le premier build
                    def isFirstBuild = currentBuild.previousBuild == null
                    
                    if (isFirstBuild) {
                        echo '‚ö†Ô∏è Premier build d√©tect√© - construction compl√®te'
                        env.SERVER_CHANGED = 'true'
                        env.CLIENT_CHANGED = 'true'
                    } else {
                        // D√©tecter les changements dans le dossier server
                        def serverChanges = sh(
                            script: 'git diff --name-only HEAD~1 HEAD | grep "^server/" || true',
                            returnStdout: true
                        ).trim()
                        
                        if (serverChanges) {
                            env.SERVER_CHANGED = 'true'
                            echo "‚úÖ Changements d√©tect√©s dans server/:"
                            echo "${serverChanges}"
                        } else {
                            echo "‚ÑπÔ∏è Aucun changement dans server/"
                        }
                        
                        // D√©tecter les changements dans le dossier client
                        def clientChanges = sh(
                            script: 'git diff --name-only HEAD~1 HEAD | grep "^client/" || true',
                            returnStdout: true
                        ).trim()
                        
                        if (clientChanges) {
                            env.CLIENT_CHANGED = 'true'
                            echo "‚úÖ Changements d√©tect√©s dans client/:"
                            echo "${clientChanges}"
                        } else {
                            echo "‚ÑπÔ∏è Aucun changement dans client/"
                        }
                    }
                    
                    echo "\nüìä R√©sum√© de la d√©tection:"
                    echo "SERVER_CHANGED: ${env.SERVER_CHANGED}"
                    echo "CLIENT_CHANGED: ${env.CLIENT_CHANGED}"
                }
            }
        }
        
        stage('Build Server Image') {
            when {
                expression { env.SERVER_CHANGED == 'true' }
            }
            steps {
                dir('server') {
                    script {
                        echo 'üèóÔ∏è Construction de l\'image Docker Server...'
                        dockerImageServer = docker.build("${IMAGE_NAME_SERVER}:${BUILD_NUMBER}", ".")
                        dockerImageServer.tag('latest')
                        echo "‚úÖ Image Server construite: ${IMAGE_NAME_SERVER}:${BUILD_NUMBER}"
                    }
                }
            }
        }
        
        stage('Build Client Image') {
            when {
                expression { env.CLIENT_CHANGED == 'true' }
            }
            steps {
                dir('client') {
                    script {
                        echo 'üèóÔ∏è Construction de l\'image Docker Client...'
                        dockerImageClient = docker.build("${IMAGE_NAME_CLIENT}:${BUILD_NUMBER}", ".")
                        dockerImageClient.tag('latest')
                        echo "‚úÖ Image Client construite: ${IMAGE_NAME_CLIENT}:${BUILD_NUMBER}"
                    }
                }
            }
        }
        
        stage('Scan Server Image') {
            when {
                expression { env.SERVER_CHANGED == 'true' }
            }
            steps {
                script {
                    echo 'üîí Scan de s√©curit√© de l\'image Server...'
                    sh """
                        trivy image --severity HIGH,CRITICAL --exit-code 0 \
                        ${IMAGE_NAME_SERVER}:${BUILD_NUMBER} || echo 'Scan termin√© avec avertissements'
                    """
                }
            }
        }
        
        stage('Scan Client Image') {
            when {
                expression { env.CLIENT_CHANGED == 'true' }
            }
            steps {
                script {
                    echo 'üîí Scan de s√©curit√© de l\'image Client...'
                    sh """
                        trivy image --severity HIGH,CRITICAL --exit-code 0 \
                        ${IMAGE_NAME_CLIENT}:${BUILD_NUMBER} || echo 'Scan termin√© avec avertissements'
                    """
                }
            }
        }
        
        stage('Push Images') {
            when {
                expression { 
                    env.SERVER_CHANGED == 'true' || env.CLIENT_CHANGED == 'true' 
                }
            }
            steps {
                script {
                    echo 'üì§ Push des images vers Docker Hub...'
                    docker.withRegistry('', DOCKERHUB_CREDENTIALS_ID) {
                        if (env.SERVER_CHANGED == 'true') {
                            echo "Pushing Server image..."
                            dockerImageServer.push("${BUILD_NUMBER}")
                            dockerImageServer.push('latest')
                            echo "‚úÖ Server image pushed: ${IMAGE_NAME_SERVER}:${BUILD_NUMBER}"
                        }
                        
                        if (env.CLIENT_CHANGED == 'true') {
                            echo "Pushing Client image..."
                            dockerImageClient.push("${BUILD_NUMBER}")
                            dockerImageClient.push('latest')
                            echo "‚úÖ Client image pushed: ${IMAGE_NAME_CLIENT}:${BUILD_NUMBER}"
                        }
                    }
                }
            }
        }
        
        stage('Deploy') {
            when {
                expression { 
                    env.SERVER_CHANGED == 'true' || env.CLIENT_CHANGED == 'true' 
                }
            }
            steps {
                script {
                    echo 'üöÄ D√©ploiement de l\'application...'
                    sh '''
                        docker-compose down || true
                        docker-compose up -d
                        sleep 5
                        docker-compose ps
                    '''
                    echo '‚úÖ D√©ploiement termin√©'
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo 'üßπ === D√âBUT DU NETTOYAGE ==='
                
                // 1. Nettoyer les conteneurs arr√™t√©s
                echo 'üóëÔ∏è Suppression des conteneurs arr√™t√©s...'
                sh '''
                    docker container prune -f || true
                    echo "Conteneurs nettoy√©s"
                '''
                
                // 2. Nettoyer les images non tagu√©es (dangling images)
                echo 'üóëÔ∏è Suppression des images non tagu√©es...'
                sh '''
                    docker image prune -f || true
                    echo "Images dangereuses nettoy√©es"
                '''
                
                // 3. Nettoyer les anciennes images (garder les 5 derni√®res versions)
                if (env.SERVER_CHANGED == 'true') {
                    echo 'üóëÔ∏è Nettoyage des anciennes images Server...'
                    sh """
                        docker images ${IMAGE_NAME_SERVER} --format "{{.ID}} {{.Tag}}" | \
                        grep -v latest | awk '{print \$1}' | tail -n +6 | \
                        xargs -r docker rmi -f || true
                    """
                }
                
                if (env.CLIENT_CHANGED == 'true') {
                    echo 'üóëÔ∏è Nettoyage des anciennes images Client...'
                    sh """
                        docker images ${IMAGE_NAME_CLIENT} --format "{{.ID}} {{.Tag}}" | \
                        grep -v latest | awk '{print \$1}' | tail -n +6 | \
                        xargs -r docker rmi -f || true
                    """
                }
                
                // 4. Nettoyer les volumes non utilis√©s
                echo 'üóëÔ∏è Suppression des volumes non utilis√©s...'
                sh '''
                    docker volume prune -f || true
                    echo "Volumes nettoy√©s"
                '''
                
                // 5. Nettoyer les r√©seaux non utilis√©s
                echo 'üóëÔ∏è Suppression des r√©seaux non utilis√©s...'
                sh '''
                    docker network prune -f || true
                    echo "R√©seaux nettoy√©s"
                '''
                
                // 6. Nettoyer le cache de build (optionnel - lib√®re beaucoup d'espace)
                echo 'üóëÔ∏è Nettoyage du cache de build Docker...'
                sh '''
                    docker builder prune -f --keep-storage 10GB || true
                    echo "Cache de build nettoy√©"
                '''
                
                // 7. Afficher l'utilisation de l'espace disque
                echo 'üìä Utilisation de l\'espace disque Docker:'
                sh 'docker system df'
                
                // 8. D√©connexion de Docker Hub
                echo 'üîì D√©connexion de Docker Hub...'
                sh 'docker logout || true'
                
                echo '‚úÖ === NETTOYAGE TERMIN√â ==='
            }
        }
        
        success {
            script {
                echo 'üéâ === PIPELINE R√âUSSI ==='
                echo "Build #${BUILD_NUMBER} termin√© avec succ√®s"
                
                if (env.SERVER_CHANGED == 'false' && env.CLIENT_CHANGED == 'false') {
                    echo '‚ÑπÔ∏è Aucun changement d√©tect√© - Aucune construction effectu√©e'
                    echo 'üí° Le pipeline a √©t√© ex√©cut√© mais aucune image n\'a √©t√© cr√©√©e'
                } else {
                    echo 'üì¶ Images construites et pouss√©es vers Docker Hub:'
                    if (env.SERVER_CHANGED == 'true') {
                        echo "  ‚úÖ Server: ${IMAGE_NAME_SERVER}:${BUILD_NUMBER}"
                        echo "             ${IMAGE_NAME_SERVER}:latest"
                    }
                    if (env.CLIENT_CHANGED == 'true') {
                        echo "  ‚úÖ Client: ${IMAGE_NAME_CLIENT}:${BUILD_NUMBER}"
                        echo "             ${IMAGE_NAME_CLIENT}:latest"
                    }
                }
                
                echo '\nüîó Liens utiles:'
                echo "  Docker Hub Server: https://hub.docker.com/r/${IMAGE_NAME_SERVER.replace('/', '/repository/')}"
                echo "  Docker Hub Client: https://hub.docker.com/r/${IMAGE_NAME_CLIENT.replace('/', '/repository/')}"
            }
        }
        
        failure {
            script {
                echo '‚ùå === PIPELINE √âCHOU√â ==='
                echo "Build #${BUILD_NUMBER} a √©chou√©"
                echo 'üìã Consultez les logs ci-dessus pour plus de d√©tails'
                
                // Afficher les logs des conteneurs en cas d'√©chec
                echo '\nüìÑ Logs des conteneurs (50 derni√®res lignes):'
                sh '''
                    docker-compose logs --tail=50 || true
                '''
                
                // Afficher les conteneurs en cours d'ex√©cution
                echo '\nüê≥ Conteneurs en cours d\'ex√©cution:'
                sh '''
                    docker ps -a || true
                '''
            }
        }
        
        unstable {
            echo '‚ö†Ô∏è Le pipeline est instable'
            echo 'Certains tests ou scans ont √©chou√© mais le build a continu√©'
        }
        
        aborted {
            echo 'üõë Pipeline annul√© par l\'utilisateur'
        }
    }
}