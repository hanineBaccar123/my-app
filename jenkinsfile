pipeline {
    agent any
    
    environment {
        DOCKERHUB_CREDENTIALS_ID = 'dockerhub-creds'
        IMAGE_NAME_SERVER = 'haninebaccar/mern-server'
        IMAGE_NAME_CLIENT = 'haninebaccar/mern-client'
        SERVER_CHANGED = 'false'
        CLIENT_CHANGED = 'false'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo ' Récupération du code source...'
                checkout scm
            }
        }
        
        stage('Detect Changes') {
            steps {
                script {
                    echo ' Détection des changements dans le repository...'
                    
                    def isFirstBuild = currentBuild.previousBuild == null
                    
                    if (isFirstBuild) {
                        echo ' Premier build détecté - construction complète'
                        env.SERVER_CHANGED = 'true'
                        env.CLIENT_CHANGED = 'true'
                    } else {
                        try {
                            def changes = bat(
                                script: '@echo off & git diff --name-only HEAD~1 HEAD',
                                returnStdout: true
                            ).trim()
                            
                            echo "Fichiers modifiés:\n${changes}"
                            
                            if (changes.toLowerCase().contains('server/')) {
                                env.SERVER_CHANGED = 'true'
                                echo " Changements détectés dans Server/"
                            }
                            
                            if (changes.toLowerCase().contains('client/')) {
                                env.CLIENT_CHANGED = 'true'
                                echo " Changements détectés dans Client/"
                            }
                        } catch (Exception e) {
                            echo " Erreur lors de la détection des changements: ${e.message}"
                            env.SERVER_CHANGED = 'true'
                            env.CLIENT_CHANGED = 'true'
                        }
                    }

                    echo "\n Résumé de la détection:"
                    echo "SERVER_CHANGED: ${env.SERVER_CHANGED}"
                    echo "CLIENT_CHANGED: ${env.CLIENT_CHANGED}"
                }
            }
        }
        
        stage('Build Server Image') {
            when {
                expression { env.SERVER_CHANGED == 'true' }
            }
            steps {
                script {
                    def serverDir = fileExists('Server') ? 'Server' : 'server'
                    echo " Utilisation du dossier: ${serverDir}"
                    
                    dir(serverDir) {
                        echo ' Construction de l\'image Docker Server...'
                        dockerImageServer = docker.build("${IMAGE_NAME_SERVER}:${BUILD_NUMBER}", ".")
                        dockerImageServer.tag('latest')
                    }
                }
            }
        }
        
        stage('Build Client Image') {
            when {
                expression { env.CLIENT_CHANGED == 'true' }
            }
            steps {
                script {
                    def clientDir = fileExists('Client') ? 'Client' : 'client'
                    echo " Utilisation du dossier: ${clientDir}"
                    
                    dir(clientDir) {
                        echo ' Construction de l\'image Docker Client...'
                        dockerImageClient = docker.build("${IMAGE_NAME_CLIENT}:${BUILD_NUMBER}", ".")
                        dockerImageClient.tag('latest')
                    }
                }
            }
        }
        
        stage('Scan Server Image') {
            when {
                expression { 
                    env.SERVER_CHANGED == 'true' && 
                    bat(script: '@echo off & where trivy', returnStatus: true) == 0 
                }
            }
            steps {
                script {
                    bat """
                        trivy image --severity HIGH,CRITICAL --exit-code 0 ${IMAGE_NAME_SERVER}:${BUILD_NUMBER}
                    """
                }
            }
        }
        
        stage('Scan Client Image') {
            when {
                expression { 
                    env.CLIENT_CHANGED == 'true' && 
                    bat(script: '@echo off & where trivy', returnStatus: true) == 0 
                }
            }
            steps {
                script {
                    bat """
                        trivy image --severity HIGH,CRITICAL --exit-code 0 ${IMAGE_NAME_CLIENT}:${BUILD_NUMBER}
                    """
                }
            }
        }
        
        stage('Push Images') {
            when {
                expression { 
                    env.SERVER_CHANGED == 'true' || env.CLIENT_CHANGED == 'true' 
                }
            }
            steps {
                script {
                    docker.withRegistry('', DOCKERHUB_CREDENTIALS_ID) {
                        if (env.SERVER_CHANGED == 'true') {
                            dockerImageServer.push("${BUILD_NUMBER}")
                            dockerImageServer.push('latest')
                        }
                        
                        if (env.CLIENT_CHANGED == 'true') {
                            dockerImageClient.push("${BUILD_NUMBER}")
                            dockerImageClient.push('latest')
                        }
                    }
                }
            }
        }
        
        stage('Deploy') {
            when {
                expression { 
                    env.SERVER_CHANGED == 'true' || env.CLIENT_CHANGED == 'true' 
                }
            }
            steps {
                script {
                    def composeCmd = bat(script: '@echo off & where docker-compose', returnStatus: true) == 0 
                        ? 'docker-compose'
                        : 'docker compose'
                    
                    bat """
                        ${composeCmd} down || exit 0
                        ${composeCmd} up -d
                        timeout /t 5 /nobreak
                        ${composeCmd} ps
                    """
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo ' === DÉBUT DU NETTOYAGE ==='
                
                try {
                    bat 'docker container prune -f || exit 0'
                    bat 'docker image prune -f || exit 0'
                    
                    if (env.SERVER_CHANGED == 'true') {
                        bat """
                            @echo off
                            docker images ${IMAGE_NAME_SERVER} --format "{{.ID}}" | findstr /v /r "^\$" > temp_server_images.txt
                            powershell -Command "\$images = Get-Content temp_server_images.txt; if (\$images.Count -gt 5) { \$images | Select-Object -Skip 5 | ForEach-Object { docker rmi -f \$_ 2>nul } }"
                            del temp_server_images.txt
                        """
                    }
                    
                    if (env.CLIENT_CHANGED == 'true') {
                        bat """
                            @echo off
                            docker images ${IMAGE_NAME_CLIENT} --format "{{.ID}}" | findstr /v /r "^\$" > temp_client_images.txt
                            powershell -Command "\$images = Get-Content temp_client_images.txt; if (\$images.Count -gt 5) { \$images | Select-Object -Skip 5 | ForEach-Object { docker rmi -f \$_ 2>nul } }"
                            del temp_client_images.txt
                        """
                    }
                    
                    bat 'docker volume prune -f || exit 0'
                    bat 'docker network prune -f || exit 0'
                    bat 'docker builder prune -f --keep-storage 10GB || exit 0'
                    bat 'docker system df || exit 0'
                    bat 'docker logout || exit 0'
                    
                } catch (Exception e) {
                    echo " Erreur pendant le nettoyage: ${e.message}"
                }
                
                echo ' === NETTOYAGE TERMINÉ ==='
            }
        }
        
        success {
            echo ' === PIPELINE RÉUSSI ==='
        }
        
        failure {
            script {
                bat 'docker-compose logs --tail=50 || docker compose logs --tail=50 || exit 0'
                bat 'docker ps -a || exit 0'
                bat 'docker images || exit 0'
            }
        }
        
        unstable {
            echo ' Pipeline instable'
        }
        
        aborted {
            echo ' Pipeline annulé'
        }
    }
}