pipeline {
    agent any
    
    environment {
        DOCKERHUB_CREDENTIALS_ID = 'dockerhub-creds'
        IMAGE_NAME_SERVER = 'haninebaccar/mern-server'
        IMAGE_NAME_CLIENT = 'haninebaccar/mern-client'
        SERVER_CHANGED = 'false'
        CLIENT_CHANGED = 'false'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ğŸ“¥ RÃ©cupÃ©ration du code source...'
                checkout scm
            }
        }
        
        stage('Detect Changes') {
            steps {
                script {
                    echo 'ğŸ” DÃ©tection des changements dans le repository...'
                    
                    // VÃ©rifier si c'est le premier build
                    def isFirstBuild = currentBuild.previousBuild == null
                    
                    if (isFirstBuild) {
                        echo 'âš ï¸ Premier build dÃ©tectÃ© - construction complÃ¨te'
                        env.SERVER_CHANGED = 'true'
                        env.CLIENT_CHANGED = 'true'
                    } else {
                        // VÃ©rifier les changements dans le dossier server (Windows)
                        def serverChanges = bat(
                            script: '@echo off & git diff --name-only HEAD~1 HEAD | findstr "^server/"',
                            returnStatus: true
                        )
                        
                        if (serverChanges == 0) {
                            env.SERVER_CHANGED = 'true'
                            echo "âœ… Changements dÃ©tectÃ©s dans server/"
                        } else {
                            echo "â„¹ï¸ Aucun changement dans server/"
                        }
                        
                        // VÃ©rifier les changements dans le dossier client (Windows)
                        def clientChanges = bat(
                            script: '@echo off & git diff --name-only HEAD~1 HEAD | findstr "^client/"',
                            returnStatus: true
                        )
                        
                        if (clientChanges == 0) {
                            env.CLIENT_CHANGED = 'true'
                            echo "âœ… Changements dÃ©tectÃ©s dans client/"
                        } else {
                            echo "â„¹ï¸ Aucun changement dans client/"
                        }
                    }
                    
                    echo "\nğŸ“Š RÃ©sumÃ© de la dÃ©tection:"
                    echo "SERVER_CHANGED: ${env.SERVER_CHANGED}"
                    echo "CLIENT_CHANGED: ${env.CLIENT_CHANGED}"
                }
            }
        }
        
        stage('Build Server Image') {
            when {
                expression { env.SERVER_CHANGED == 'true' }
            }
            steps {
                dir('server') {
                    script {
                        echo 'ğŸ—ï¸ Construction de l\'image Docker Server...'
                        dockerImageServer = docker.build("${IMAGE_NAME_SERVER}:${BUILD_NUMBER}", ".")
                        dockerImageServer.tag('latest')
                        echo "âœ… Image Server construite: ${IMAGE_NAME_SERVER}:${BUILD_NUMBER}"
                    }
                }
            }
        }
        
        stage('Build Client Image') {
            when {
                expression { env.CLIENT_CHANGED == 'true' }
            }
            steps {
                dir('client') {
                    script {
                        echo 'ğŸ—ï¸ Construction de l\'image Docker Client...'
                        dockerImageClient = docker.build("${IMAGE_NAME_CLIENT}:${BUILD_NUMBER}", ".")
                        dockerImageClient.tag('latest')
                        echo "âœ… Image Client construite: ${IMAGE_NAME_CLIENT}:${BUILD_NUMBER}"
                    }
                }
            }
        }
        
        stage('Scan Server Image') {
            when {
                expression { env.SERVER_CHANGED == 'true' }
            }
            steps {
                script {
                    echo 'ğŸ”’ Scan de sÃ©curitÃ© de l\'image Server...'
                    // Note: Trivy doit Ãªtre installÃ© sur Windows
                    bat """
                        trivy image --severity HIGH,CRITICAL --exit-code 0 ${IMAGE_NAME_SERVER}:${BUILD_NUMBER} || echo Scan termine avec avertissements
                    """
                }
            }
        }
        
        stage('Scan Client Image') {
            when {
                expression { env.CLIENT_CHANGED == 'true' }
            }
            steps {
                script {
                    echo 'ğŸ”’ Scan de sÃ©curitÃ© de l\'image Client...'
                    bat """
                        trivy image --severity HIGH,CRITICAL --exit-code 0 ${IMAGE_NAME_CLIENT}:${BUILD_NUMBER} || echo Scan termine avec avertissements
                    """
                }
            }
        }
        
        stage('Push Images') {
            when {
                expression { 
                    env.SERVER_CHANGED == 'true' || env.CLIENT_CHANGED == 'true' 
                }
            }
            steps {
                script {
                    echo 'ğŸ“¤ Push des images vers Docker Hub...'
                    docker.withRegistry('', DOCKERHUB_CREDENTIALS_ID) {
                        if (env.SERVER_CHANGED == 'true') {
                            echo "Pushing Server image..."
                            dockerImageServer.push("${BUILD_NUMBER}")
                            dockerImageServer.push('latest')
                            echo "âœ… Server image pushed: ${IMAGE_NAME_SERVER}:${BUILD_NUMBER}"
                        }
                        
                        if (env.CLIENT_CHANGED == 'true') {
                            echo "Pushing Client image..."
                            dockerImageClient.push("${BUILD_NUMBER}")
                            dockerImageClient.push('latest')
                            echo "âœ… Client image pushed: ${IMAGE_NAME_CLIENT}:${BUILD_NUMBER}"
                        }
                    }
                }
            }
        }
        
        stage('Deploy') {
            when {
                expression { 
                    env.SERVER_CHANGED == 'true' || env.CLIENT_CHANGED == 'true' 
                }
            }
            steps {
                script {
                    echo 'ğŸš€ DÃ©ploiement de l\'application...'
                    bat '''
                        docker-compose down
                        docker-compose up -d
                        timeout /t 5 /nobreak
                        docker-compose ps
                    '''
                    echo 'âœ… DÃ©ploiement terminÃ©'
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo 'ğŸ§¹ === DÃ‰BUT DU NETTOYAGE ==='
                
                // 1. Nettoyer les conteneurs arrÃªtÃ©s
                echo 'ğŸ—‘ï¸ Suppression des conteneurs arrÃªtÃ©s...'
                bat 'docker container prune -f || exit 0'
                
                // 2. Nettoyer les images non taguÃ©es
                echo 'ğŸ—‘ï¸ Suppression des images non taguÃ©es...'
                bat 'docker image prune -f || exit 0'
                
                // 3. Nettoyer les anciennes images Server (garder les 5 derniÃ¨res)
                if (env.SERVER_CHANGED == 'true') {
                    echo 'ğŸ—‘ï¸ Nettoyage des anciennes images Server...'
                    bat """
                        @echo off
                        for /f "skip=5 tokens=3" %%i in ('docker images ${IMAGE_NAME_SERVER} --format "{{.ID}} {{.Tag}}" ^| findstr /v "latest"') do docker rmi -f %%i 2>nul
                    """ 
                }
                
                // 4. Nettoyer les anciennes images Client (garder les 5 derniÃ¨res)
                if (env.CLIENT_CHANGED == 'true') {
                    echo 'ğŸ—‘ï¸ Nettoyage des anciennes images Client...'
                    bat """
                        @echo off
                        for /f "skip=5 tokens=3" %%i in ('docker images ${IMAGE_NAME_CLIENT} --format "{{.ID}} {{.Tag}}" ^| findstr /v "latest"') do docker rmi -f %%i 2>nul
                    """
                }
                
                // 5. Nettoyer les volumes non utilisÃ©s
                echo 'ğŸ—‘ï¸ Suppression des volumes non utilisÃ©s...'
                bat 'docker volume prune -f || exit 0'
                
                // 6. Nettoyer les rÃ©seaux non utilisÃ©s
                echo 'ğŸ—‘ï¸ Suppression des rÃ©seaux non utilisÃ©s...'
                bat 'docker network prune -f || exit 0'
                
                // 7. Nettoyer le cache de build
                echo 'ğŸ—‘ï¸ Nettoyage du cache de build Docker...'
                bat 'docker builder prune -f --keep-storage 10GB || exit 0'
                
                // 8. Afficher l'utilisation de l'espace disque
                echo 'ğŸ“Š Utilisation de l\'espace disque Docker:'
                bat 'docker system df'
                
                // 9. DÃ©connexion de Docker Hub
                echo 'ğŸ”“ DÃ©connexion de Docker Hub...'
                bat 'docker logout || exit 0'
                
                echo 'âœ… === NETTOYAGE TERMINÃ‰ ==='
            }
        }
        
        success {
            script {
                echo 'ğŸ‰ === PIPELINE RÃ‰USSI ==='
                echo "Build #${BUILD_NUMBER} terminÃ© avec succÃ¨s"
                
                if (env.SERVER_CHANGED == 'false' && env.CLIENT_CHANGED == 'false') {
                    echo 'â„¹ï¸ Aucun changement dÃ©tectÃ© - Aucune construction effectuÃ©e'
                } else {
                    echo 'ğŸ“¦ Images construites et poussÃ©es vers Docker Hub:'
                    if (env.SERVER_CHANGED == 'true') {
                        echo "  âœ… Server: ${IMAGE_NAME_SERVER}:${BUILD_NUMBER}"
                        echo "             ${IMAGE_NAME_SERVER}:latest"
                    }
                    if (env.CLIENT_CHANGED == 'true') {
                        echo "  âœ… Client: ${IMAGE_NAME_CLIENT}:${BUILD_NUMBER}"
                        echo "             ${IMAGE_NAME_CLIENT}:latest"
                    }
                }
            }
        }
        
        failure {
            script {
                echo 'âŒ === PIPELINE Ã‰CHOUÃ‰ ==='
                echo "Build #${BUILD_NUMBER} a Ã©chouÃ©"
                echo 'ğŸ“‹ Consultez les logs ci-dessus pour plus de dÃ©tails'
                
                // Afficher les logs des conteneurs en cas d'Ã©chec
                echo '\nğŸ“„ Logs des conteneurs (50 derniÃ¨res lignes):'
                bat 'docker-compose logs --tail=50 || exit 0'
                
                // Afficher les conteneurs en cours d'exÃ©cution
                echo '\nğŸ³ Conteneurs en cours d\'exÃ©cution:'
                bat 'docker ps -a || exit 0'
            }
        }
        
        unstable {
            echo 'âš ï¸ Le pipeline est instable'
        }
        
        aborted {
            echo 'ğŸ›‘ Pipeline annulÃ© par l\'utilisateur'
        }
    }
}